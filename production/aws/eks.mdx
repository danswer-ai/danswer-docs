---
title: "EKS"
description: "Setup Onyx on AWS EKS"
---

## Prerequisites

- Download and install the [AWS CLI](https://aws.amazon.com/cli/). This is required for creating and accessing the cluster.
- Download and install [kubectl CLI](https://kubernetes.io/docs/tasks/tools/install-kubectl-macos/). This is needed for cluster access through the cli.

## Cluster Setup and Configuration

### Create the Cluster

Navigate to Elastic Kubernetes Service (EKS) and create a new cluster.

For `Cluster service role`, create a new IAM role accepting all the defaults for the user. It's name can
be something like `onyx-eks-cluster-role`.
Make sure to click the refresh button if you don't see it as an option!

For the `Kubernetes version`, select a version with standard support still offered and under `Upgrade policy`, select `Standard`. In the add-ons section, make sure to add the `Amazon EBS CSI Driver` add-on, as this is needed for the Persistent Volume Claims (PVCs) to be fulfilled. Also make sure to keep the other default add-ons!

![Cluster creation screen](/images/setup_guides/aws/eks/cluster_create.png)

Select defaults for the rest of the forms. Finally, review the complete cluster setup and click `Create` when satisfied. The cluster may take several minutes to become ready.

### Adding Nodes

Next we need to add worker nodes to the cluster. This is where the Onyx services will reside.

When the cluster is Active and while viewing the cluster, select the `Compute` tab and then `Add node group`.

![Adding a node group](/images/setup_guides/aws/eks/add_node_group.png)

First, provide a `Name` for the group (something like `onyx-node-group`). For `Node IAM role`, either select
an existing role that your organization has setup or create a new role. Whichever route we choose, we have to make sure
that the `AmazonEBSCSIDriverPolicy` is attached to the role, as this will be needed for our Persistent Volume Claims (PVCs)
to be fulfilled. If creating a role, all the other defaults provided by AWS should work (with the addition of the `AmazonEBSCSIDriverPolicy`). Give the role a name like `onyx-eks-nodegroup-role`.

![Configure group node](/images/setup_guides/aws/eks/configure_group_node.png)

Replace the `Instance Types` with `c5.2xlarge` machines (or `c5.4xlarge` if you are planning on scaling up beyond 100k documents). For disk, we recommend setting `Volume size` somewhere in the 200GB - 800GB range depending on how many documents you plan on indexing (storage is cheap). For most setups, we recommend setting the `Desired size` and `Minimum size` to 1, although you can increase this if needed to scale the cluster up once traffic picks up. Maximum unavailable can generally be left as default.

After reviewing, keep the default for the Networking section, and then proceed through to `Create`!

![Setting compute and scaling](/images/setup_guides/aws/eks/set_compute_and_scaling.png)

This may take up to 15 minutes for the compute nodes to come online.

### Create and Connect a User

You will need to create an IAM user that will have access AWS and the cluster from the command line.

Navigate to the `IAM Dashboard` found [here](https://console.aws.amazon.com/iam/). Select `Users` on the left sidebar and then `Create user`.

![Create user](/images/setup_guides/aws/eks/iam_dashboard.png)

Give the user a name like `onyx-eks-user`. For the user permissions, click `Attach policies directly` and provide the following permissions:

- `AmazonEKSClusterPolicy`
- `AmazonEKSServicePolicy`

Finishing reviewing and creating the user.

Back on the user's page, click into the newly created user, and then select `Create access key`.

![Create access key](/images/setup_guides/aws/eks/create_access_key.png)

Follow the process for creating the access key and secret. Select the `Command Line Interferace (CLI)` option during creation. Be sure to save the `Access key` and `Secret access key` for later.

Navigate back to the EKS cluster and select `Access` and then `Create access entry`.

![EKS access entry](/images/setup_guides/aws/eks/eks_access_entry.png)

In the `IAM principal` select the IAM ARN that you just created. Then click next.

![EKS IAM ARN](/images/setup_guides/aws/eks/eks_iam_arn.png)

For the Access policies, ensure that the `Policy name` is set to `AmazonEKSClusterAdminPolicy` and then click next. Review and then create the Access Policy.

![EKS policy](/images/setup_guides/aws/eks/eks_policy.png)

## Fetching the kubeconfig file

Log into the AWS CLI with `aws configure` and provide the access key and secret key from the IAM you created.

Then configure aws to connect with the cluster filling in the `region-code` and `cluster-name` in the following command

```shell
aws eks update-kubeconfig --region region-code --name cluster-name
```

Additional material found on the [AWS EKS documentation](https://docs.aws.amazon.com/eks/latest/userguide/create-kubeconfig.html).

## Installing the Services

You will want to create a [namespace](https://kubernetes.io/blog/2016/08/kubernetes-namespaces-use-cases-insights/) for this to install. Namespaces are logical separations of grouped services for resource and permission managament.

```shell
kubectl create ns onyx
```

Next, we need to make sure that the gp2 storage class is set to the default storage class. This can be done by running the following command:

```shell
kubectl patch storageclass gp2 -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}' -n onyx
```

Navigate to the `onyx/deployment/kubernetes` directory in the repository that you have cloned down

Afterwards, you can run the installation of the `yaml` files

```shell
kubectl apply -f . -n onyx
```

It may take a few minutes for the all the services to come online. To monitor the progress, run the following command:

```shell
kubectl -n onyx get pods
```

To check the status of the API server (usually the last to come online), run the following command:

```shell
kubectl -n onyx get pods | grep api-server | awk '{print $1}' | xargs -I {} kubectl -n onyx logs {} -f
```

You can navigate find the nginx load balancer by running the following command and then navigating to the url provided.

```shell
kubectl get svc -n onyx | grep nginx-service | awk '{print $4}'
```



## Setting Up Managed Services

Instead of running Redis and PostgreSQL in containers within your EKS cluster, we'll set up Amazon RDS for PostgreSQL and Amazon ElastiCache for Redis. This provides managed, scalable, and highly available database services.

### Setting Up Amazon RDS for PostgreSQL

1. **Navigate to the Amazon RDS Console**: Go to the [Amazon RDS Console](https://console.aws.amazon.com/rds/home).

2. **Create a New Database**:

   - Click on **"Create database"**.
   - Under **Engine options**, select **"PostgreSQL"**.
   - Choose the latest engine version (e.g., **PostgreSQL 15.7**).


3. **Specify DB Details**:

   - **Templates**: Select **"Production"** for a high-availability setup.
   - **DB instance identifier**: Enter a name like `danswer-postgres`.
   - **Master username and password**:
     - **Master username**: Choose a username (e.g., `admin`).
     - **Master password**: Set a secure password or use the **"Auto generate a password"** option. If you set your own password, **note it down**. If you use the auto-generate option, make sure to **securely store the generated password**. You'll need this password later.

   *![RDS Creation](/images/setup_guides/aws/eks/rds_creation.png)*

4. **Configure Instance**:

   - **DB instance class**: Choose an instance type suitable for your workload, such as `db.t3.medium` (2 vCPUs, 4 GiB RAM).
   - **Storage Type**: Select **General Purpose SSD (gp3)**.
   - **Allocated storage**: Set to at least **200 GiB** (adjust based on your needs).

   ![RDS Naming](/images/setup_guides/aws/eks/rds_naming.png)*

5. **Connectivity**:

   - **Virtual Private Cloud (VPC)**: Select the same VPC used by your EKS cluster.
   - **Subnet group**: Use a subnet group that includes the same subnets as your EKS nodes.
   - **Public access**: Set to **"No"** to keep the database private within your VPC.
   - **VPC security group (firewall)**:
     - Select or create a security group that allows inbound traffic from your EKS nodes on port `5432`.

   ![RDS Security](/images/setup_guides/aws/eks/rds_security.png)

6. **Database Authentication**:

   - Ensure **"Password authentication"** is enabled.

7. **Create Database**:


8. **Retrieve the Endpoint**:

   - Once the database is available, go to the **"Databases"** section.
   - Click on your database and find the **"Endpoint & port"** section.
   - **Note down the endpoint URL**; you'll use it to configure your application.


### Setting Up Amazon ElastiCache for Redis

1. **Navigate to the ElastiCache Console**: Go to the [Amazon ElastiCache Console](https://console.aws.amazon.com/elasticache/home).

2. **Create a Redis Cluster**:

   - Click on **"Create"** and select **"Redis OSS"**.

3. **Cluster Details**:

   - **Cluster name**: Enter a name like `danswer-redis`.
   - **Engine version**: Choose the latest version (e.g., **Redis 7.1**).
   - **Cluster mode**: Click on "Design your own cache" and then select "Cluster cache" to configure your Redis cluster according to your specific requirements.

- ![Redis Creation](/images/setup_guides/aws/eks/redis_creation.png)



4. **Security**:


   - **VPC security groups**:
     - Select or create a security group that allows inbound traffic from your EKS nodes on port `6379`.
   - **Encryption in transit**:
     - **Enable** to secure data in transit.
     - **Transit encryption mode**: Choose **"Required"** to enforce TLS connections.
   - **At-rest encryption**: Enable if you need encryption of data at rest.

   ![Redis Security](/images/setup_guides/aws/eks/redis_security.png)


5. **Create Cluster**:

   - Review all configurations and click **"Create"**.

6. **Retrieve the Endpoint**:

   - Once the cluster is available, go to the cluster details.
   - **Note down the Primary Endpoint**; you'll use it to configure your EKS cluster.


### Updating Kubernetes Configuration

With your managed services set up, you'll need to update your application's Kubernetes configuration to use them. The `cloud_kubernetes` directory already contains the necessary modifications for using managed services. You just need to update the configuration with your specific managed service details.

1. **Navigate to Cloud Kubernetes Configuration**:

   ```shell
   cd danswer/deployment/cloud_kubernetes
   ```

2. **Update Environment Configuration**:

   Edit the `env-configmap.yaml` file to include your RDS and Redis endpoints:

   ```yaml
   apiVersion: v1
   kind: ConfigMap
   metadata:
     name: env-configmap
   data:
     # PostgreSQL Configuration
     POSTGRES_HOST: "<your-rds-endpoint>"    # e.g., danswer-postgres.xxxxxx.us-east-1.rds.amazonaws.com
     POSTGRES_PORT: "5432"
     POSTGRES_USER: "<your-db-username>"     # e.g., admin
     POSTGRES_DB: "postgres"
     # Redis Configuration
     REDIS_HOST: "<your-redis-endpoint>"     # e.g., danswer-redis.xxxxxx.ng.0001.use1.cache.amazonaws.com
     REDIS_PORT: "6379"
     REDIS_SSL: "true"
   ```


3. **Create Kubernetes Secrets for Sensitive Data**:

   Store database passwords and Redis AUTH tokens securely using Kubernetes Secrets:

   ```shell
   kubectl create secret generic postgres-secret \
     --from-literal=POSTGRES_PASSWORD='<your-db-password>' \
     --namespace danswer

   kubectl create secret generic redis-secret \
     --from-literal=REDIS_PASSWORD='<your-redis-password>' \
     --namespace danswer
   ```


4. **Deploy the Updated Configuration**:

   Apply the configurations from the `cloud_kubernetes` directory:

   ```shell
   kubectl apply -f . -n danswer
   ```


   Note: The deployment files in `cloud_kubernetes` are already set up to use these secrets and managed services. You don't need to modify them further.
